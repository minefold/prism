#!/usr/bin/env ruby
require 'bundler/setup'
Bundler.require :default

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'minefold'

abort "Usage: stop-world id" unless ARGV.length == 1
world_id = ARGV.shift

# Stop world
world = LocalWorlds.running.find {|w| w[:id] == world_id }
`bundle exec god stop #{world[:god_name]}` if world

puts "Waiting for world to stop"
while LocalWorlds.running.any? {|w| w[:id] == world_id } do
end
puts "Done"

exit 0 unless Dir.exists? "#{WORLDS}/#{world_id}"

# backup world
puts "Backing up"
`bundle exec #{BIN}/backup-world #{world_id}`
abort "Backup failed" if $?.exitstatus != 0

# remove world
puts "Removing"
FileUtils.rm_rf "#{WORLDS}/#{world_id}"
