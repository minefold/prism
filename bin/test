#!/usr/bin/env ruby

require 'bundler/setup'
Bundler.require :default, :chatty, :proxy

$:.unshift File.join File.dirname(__FILE__), '..', 'lib'
require 'minefold'
require 'prism/back'
require 'awesome_print'

username = ARGV.shift

class RealUniverse
  def self.collect *c, &b
    cb = EM::Callback(*c, &b)
    Box.all {|boxes| cb.call RealUniverse.new boxes}
    cb
  end
  
  attr_reader :boxes
  
  def initialize boxes
    @boxes = boxes
  end
  
end

EM.run do
  # Prism::RedisUniverse.collect {|universe| ap universe.boxes, universe.worlds; EM.stop }

  # RealUniverse.collect {|universe| ap universe.boxes; EM.stop }
  
  Prism.redis.publish_json "players:connection_request:#{username}", rejected:'500'
  
  # op = Prism.redis.keys("worlds:*:connected_players")
  # op.callback do |keys| 
  #   EM::Iterator.new(keys).map(proc { |key, iter|
  #     op = Prism.redis.smembers key
  #     op.callback {|players| iter.return players }
  #     op.errback { iter.return [] }
  #   }, proc {|players| p players.flatten })
  # end
end
