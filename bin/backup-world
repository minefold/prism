#!/usr/bin/env ruby
require 'bundler/setup'
Bundler.require :default, :backup

ROOT = File.expand_path "../..", __FILE__

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'fileutils'
require 'worlds'
require 'storage'

FileUtils.mkdir_p "#{ROOT}/backups"

world_name = ARGV.shift

world_archive = "#{ROOT}/backups/#{world_name}.tar.gz"

# tar gz world
Dir.chdir "#{ROOT}/worlds" do
  `tar czf '#{world_archive}' '#{world_name}'`
end

directory = Storage.new.worlds

# TODO: investigate streaming of this file
file = directory.files.create(
  :key    => "#{world_name}.tar.gz",
  :body   => File.open(world_archive),
  :public => false
)

FileUtils.rm world_archive
