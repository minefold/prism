#!/usr/bin/env ruby
# encoding: UTF-8
require 'bundler/setup'
Bundler.require :default

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'minefold'
require 'prism/back'

STDOUT.sync = true
EM.epoll

module Prism

  class Sweepy
    def initialize
      @sweeper = Sweeper.new
    end

    def start_sweepin
      started_at = Time.now

      @timeout = EM.add_periodic_timer(120) do
        raise "Sweep took too long"
      end

      @sweeper.perform_sweep do
        @timeout.cancel
        @sweeper.record_stats
        StatsD.measure started_at, "sweeper.sweep"
        
        EM.add_timer(5) { start_sweepin }
      end
    end
  end

  EM.run do
    puts "Started. #{Fold.env} mode"

    EM.error_handler do |e|
      Exceptional.handle(e)
      raise e
    end

    Sweepy.new.start_sweepin
  end
end