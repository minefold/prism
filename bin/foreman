#!/usr/bin/env ruby
# encoding: UTF-8

require 'bundler/setup'
Bundler.require :foreman

module Foreman
  class ServerWatcher < EventMachine::Connection
    attr_accessor :on_exit
    
    def receive_data(data) # :nodoc:
      puts data
    end
    
    def unbind
      puts "CRAZASH!"
      on_exit.call
    end
    
  end

  def self.start_server(port = 3000)
    dir = File.expand_path(File.join File.dirname(__FILE__), "..")
    cmd = '/bin/sh -c "cd mc && java -Xmx1024M -Xms512M -jar server.jar nogui 2>&1"'
    EM.popen(cmd, ServerWatcher) do |watcher|
      watcher.on_exit = proc { start_server(port) }
    end
  end
end


EM.run do
  Foreman.start_server
end
