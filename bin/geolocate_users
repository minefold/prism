#!/usr/bin/env ruby
# encoding: UTF-8

require 'bundler/setup'
Bundler.require :default, :geo

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'minefold'
require 'prism/back'

include Prism::Mongo
mongo = mongo_connect

mongo['users'].find({ '$or' => [
                          {'geo_location' => {'$exists' => false}}
                          # {'geo_location.success' => false},
                      ]}).select{|user| user['last_sign_in_ip'] && user['last_sign_in_ip'].size > 0 }.each do |user|

  g = Geokit::Geocoders::MultiGeocoder.geocode(user['last_sign_in_ip'])
  puts [user['username'], user['last_sign_in_ip'], g.country_code,g.state,g.city].join(", ")

  mongo['users'].update({'_id' => user['_id']}, {'$set' => {:geo_location => g.to_hash}})

  sleep 1
end
