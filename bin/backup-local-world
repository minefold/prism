#!/usr/bin/env ruby
require 'bundler/setup'
Bundler.require :default

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'minefold'

world_id = ARGV.shift

FileUtils.mkdir_p "#{ROOT}/backups"

world_archive = "#{ROOT}/backups/#{world_id}.tar.gz"

FileUtils.touch world_archive

# tar gz world
puts "Archiving"
Dir.chdir "#{ROOT}/worlds" do
  puts `pwd`
  command = "tar -czf '#{world_archive}' '#{world_id}' --exclude='server.jar'"
  puts command
  
  result = `#{command}`
  puts result unless $?.exitstatus == 0
end
abort "error" unless $?.exitstatus == 0

directory = Storage.new.worlds

# TODO: investigate streaming of this file
puts "Uploading"
file = directory.files.create(
  :key    => "#{world_id}.tar.gz",
  :body   => File.open(world_archive),
  :public => false
)

FileUtils.rm world_archive
