#!/usr/bin/env ruby
require 'bundler/setup'
Bundler.require :default, :cli

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'minefold'
require 'cli'

def usage
  puts "minefold <args>"
  puts "  player:[username]"
  puts "  player:[username] add-minutes:[amount]"
  puts ""
  puts "  world:[world_id]"
end

abort usage unless ARGV.any?

args = ARGV.clone
args = ARGV.map {|a| a.split(':') }

DB_CONNECTION = Mongo::Connection.from_uri(ENV['MONGOHQ_URL'])
db_name = 'minefold'
if DB_CONNECTION.auths.any?
  db_name = DB_CONNECTION.auths.first['db_name']
end
DB = DB_CONNECTION[db_name]

resource_name, resource_id = args.shift

resource = case resource_name
when 'player'
  PlayerCommand.new resource_id
when 'world'
  WorldCommand.new resource_id
else
  abort usage
end

while sub_cmd = args.shift
  command_name, *command_args = sub_cmd
  command_name = command_name.gsub /\-/, '_'
  resource.send command_name, *command_args
end

resource.show