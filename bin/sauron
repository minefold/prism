#!/usr/bin/env ruby
# encoding: UTF-8
require 'bundler/setup'
Bundler.require :default, :proxy
require 'json'

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'minefold'

class PlayerConnectionHandler
  def connect
    @connection = EM::Hiredis.connect
    @connection.callback { listen }
  end
  
  def listen
    puts "listening"
    @pop = @connection.brpop "players:connecting", 0
    @pop.callback { |username| player_connecting username }
    @pop.errback { |e| puts ":(\n#{e}" }
  end
  
  def player_connecting username
    puts "oh hai #{username}!"
    listen
  end
end

EM.epoll
EM.run do
  EM.add_timer(4) { PlayerConnectionHandler.new.connect }

  EM.add_periodic_timer(1) { print "." }
  
  redis = EM::Hiredis.connect
  redis.callback { 
    EM.add_timer(1) { redis.lpush "players:connecting", "whatupdave" }
    EM.add_timer(2) { redis.lpush "players:connecting", "chrislloyd" }
    EM.add_timer(3) { redis.lpush "players:connecting", "notch" }
  }
  
  
end
