#!/usr/bin/env ruby
# encoding: UTF-8
require 'bundler/setup'
Bundler.require :default, :proxy

$:.unshift File.join File.dirname(__FILE__), '../lib'
require 'minefold'
require 'prism/front'

STDOUT.sync = true
EM.epoll

module Prism
  EM.run do
    puts "Initialising"
    redis = Prism.redis
    
    subscription = PrismRedis.connect
    subscription.psubscribe "players:connection_request:*"
    subscription.on :pmessage do |key, channel, message|
      puts " â€¢ [#{channel}] #{message}"
      
      Prism::Messaging.deliver_message channel, message
    end

    
    op = redis.keys("worlds:*:connected_players")
    op.callback {|key| redis.del key }

    redis.del("players:playing") do
      redis.del("prism:active_connections") do

        EM.start_server '0.0.0.0', 25565, Client
        puts "#{Fold.env} mode. listening on 0.0.0.0:25565"
      end
    end
    
    # EM.add_periodic_timer(1) { puts EM.connection_count }
  end
end
